<!doctype html>
<html>
<head>
	<meta charset="utf-8">
	<script src="../bower_components/webcomponentsjs/webcomponents.js"></script>
	<script src="../bower_components/web-component-tester/browser.js"></script>
	<script src="TestHelper.js"></script>
	<script>
		var should = chai.should();
	</script>
	<script src="//cdnjs.cloudflare.com/ajax/libs/jquery/1.11.1/jquery.js"></script>
	<link rel="import" href="../build/mm-dropdown/mm-dropdown.html">
	<link rel="import" href="../build/mm-list-item/mm-list-item.html">
</head>
<body>

	<mm-dropdown id="ddl" placeholder="some longer label">
		<mm-list-item value="1">mm-list-item 01</mm-list-item>
		<mm-list-item value="2">mm-list-item 02</mm-list-item>
		<mm-list-item value="3">mm-list-item 03</mm-list-item>
		<mm-list-item value="4">mm-list-item 04</mm-list-item>
	</mm-dropdown>

	<div style="width:500px;">
		<mm-dropdown id="ddlFit" placeholder="some longer label" max-items="4" fitparent>
			<mm-list-item value="item01">mm-list-item 01</mm-list-item>
			<mm-list-item value="item02">mm-list-item 02</mm-list-item>
			<mm-list-item value="item03">mm-list-item 03</mm-list-item>
			<mm-list-item value="item04">mm-list-item 04</mm-list-item>
			<mm-list-item value="item05">mm-list-item 05</mm-list-item>
			<mm-list-item value="item06">mm-list-item 06</mm-list-item>
			<mm-list-item value="item07">mm-list-item 07</mm-list-item>
			<mm-list-item value="item08">mm-list-item 08</mm-list-item>
			<mm-list-item value="item09">mm-list-item 09</mm-list-item>
			<mm-list-item value="item10">mm-list-item 10</mm-list-item>
			<mm-list-item value="item11">mm-list-item 11</mm-list-item>
			<mm-list-item value="item12">mm-list-item 12</mm-list-item>
			<mm-list-item value="item13">mm-list-item 13</mm-list-item>
			<mm-list-item value="item14">mm-list-item 14</mm-list-item>
			<mm-list-item value="item15">mm-list-item 15</mm-list-item>
			<mm-list-item value="item16">mm-list-item 16</mm-list-item>
		</mm-dropdown>
	</div>

	<mm-dropdown placeholder="select one" overflow="visible" id="ddlOverflow" unresolved>
		<mm-list-item>mm-list-item with an exremely long label or name in here 01</mm-list-item>
		<mm-list-item>mm-list-item with an exremely long label or name in here 02</mm-list-item>
		<mm-list-item>mm-list-item with an exremely long label or name in here 03</mm-list-item>
		<mm-list-item>mm-list-item with an exremely long label or name in here 04</mm-list-item>
	</mm-dropdown>

	<mm-dropdown id="ddlJquery"></mm-dropdown>

	<mm-dropdown id="ddlLarge"></mm-dropdown>

	<script type="text/javascript">

		describe("mm-dropdown", function() {

			it("should have an element constructor", function() {
				var a = new Strand.Dropdown();
				a.nodeName.should.equal("MM-DROPDOWN");
			});

			it("should fit to parent if fitparent set", function(done) {
				var ddlFit = document.querySelector("#ddlFit"),
					width = 0;

				flush(function() {
					width = TestHelper.widthIntRounded(ddlFit);
					width.should.equal(500);
					done();
				});
			});

			it("should toggle", function() {
				var ddl = document.getElementById('ddl');
				ddl.state.should.equal(ddl.STATE_CLOSED);
				ddl.toggle();
				ddl.state.should.equal(ddl.STATE_OPENED);
				ddl.toggle();
				ddl.state.should.equal(ddl.STATE_CLOSED);
			});

			it("should be able to select item by value as a number", function(done) {
				var ddl = document.getElementById('ddl');

				ddl.value = 2;
				flush(function() {
					ddl.selectedIndex.should.equal(1);
					done();
				});
			});

			it("should be able to select item by value as a string", function(done) {
				var ddl = document.getElementById('ddl');

				ddl.value = "3";
				flush(function() {
					ddl.selectedIndex.should.equal(2);
					done();
				});
			});

			it("should update label when selected", function(done) {
				var ddl = document.getElementById('ddl'),
					selectedItem = null
					selectedItemName = null,
					label = null;

				ddl.selectedIndex = 2;
				flush(function() {
					selectedItem = ddl.items[ddl.selectedIndex];
					selectedItemName = selectedItem.textContent.trim();
					label = ddl._target.querySelector('label').textContent.trim();
					label.should.equal(selectedItemName);
					done();
				});
			});

			/*
			it("should be Jqueryable", function(done) {
				var a = $('#ddlJquery');
				for(var i=0; i<100; i++) {
					var item = $("<mm-list-item id='item" + i +"'>List Item Here" + i + "</mm-list-item>");
					item.appendTo(a);
				}

				setTimeout(function() {
					var b = document.getElementById('ddlJquery');
					b.panel.$.container.children.length.should.equal(102); // 2 additional children should be <template>s
					done();
				}, 150);
			});

			it("should clamp height", function(done) {
				var a = document.getElementById('ddlLarge');
				for(var i=0; i<10; i++) {
					var item = document.createElement('mm-list-item');
					item.innerText = "mm-list-item " + i;
					a.appendChild(item);
				}
				a.open();

				setTimeout(function() {
					var panelRect = a.panel.getBoundingClientRect();
					panelRect.height.should.be.lessThan(window.innerHeight);
					panelRect.top.should.be.at.least(0);
					panelRect.bottom.should.be.at.most(window.innerHeight);
					done();
				}, 150);
			});

			TODO: max-items, data dropdown
			
			*/

			it("should dispatch a selected event", function(done) {
				var ddl = document.getElementById("ddlFit"),
					s = sinon.spy();

				ddl.addEventListener("selected", s);
				ddl.selectedIndex = 0;
				flush(function() {
					should.equal(s.calledOnce, true);
					done();
				});
			});

			it("should dispatch a selected event with the correct event detail", function(done) {
				var ddl = document.getElementById("ddlFit"),
					evt = null,
					item = null;

				ddl.addEventListener("selected", function(e) {
					evt = e.detail;

					evt.item.should.exist;
					evt.index.should.exist;
					evt.value.should.exist;
					evt.name.should.exist;
					evt.selected.should.exist;

					evt.item.should.be.an('object');
					evt.index.should.be.a('number');
					evt.value.should.be.a('string');
					evt.name.should.be.a('string');
					evt.selected.should.be.a('boolean');

					evt.item.should.equal(Polymer.dom(ddl).querySelectorAll('mm-list-item')[4]);
					evt.index.should.equal(4);
					evt.value.should.equal('item05');
					evt.name.should.equal('mm-list-item 05');
					evt.selected.should.equal(true);
					
					done();
				});

				ddl.selectedIndex = 4;
			});

		});

	</script>

</body>
</html>