<link rel="import" href="ajaxplugin.html"/>
<link rel="import" href="storage.html"/>
<link rel="import" href="datautils.html"/>
<script>
(function(scope) {
	var DataUtils = StrandLib.DataUtils;
	var Storage = StrandLib.Storage;

	scope.AjaxCSRFPlugin = function (config) {
		this.config = DataUtils.copy({
			useCache:true,
			header:"X-CSRF-Token",
			enabled:true, 
			token:""
		}, config);

		if (this.config.useCache) {
			this.storage = new Storage("csrf");
			this.config.token = this.config.token || this.storage.value;
		}
	};

	scope.AjaxCSRFPlugin.prototype = {

		requestHandler:function(ajaxOpts) {
			var headers = DataUtils.getPathValue("headers", ajaxOpts);
			if (this.config.enabled && headers && this.config.token) {
				var csrf = DataUtils.param(this.config.header, this.config.token);
				headers.push(csrf);
			}
			return ajaxOpts;
		},

		responseHandler:function(response) {
			var xhr = DataUtils.getPathValue("instance.xhr",response);
			var hasHeader = xhr && xhr.getAllResponseHeaders().indexOf(this.config.header) !== -1;
			if (hasHeader && this.config.enabled) {
		  		var csrf = xhr.getResponseHeader(this.config.header);
		  		this.config.token = csrf;
		  		if (this.config.useCache) {
					this.storage.value = csrf;
				}
			}
			return response;
		}
	};
}(window.StrandLib = window.StrandLib || {}));

</script>
