<link rel="import" href="ajaxplugin.html"/>
<link rel="import" href="storage.html"/>
<link rel="import" href="datautils.html"/>
<script>
(function(scope) {
	var DataUtils = StrandLib.DataUtils;
	var Storage = StrandLib.Storage;

	scope.AjaxCSRFPlugin = function (useCache, header, enabled, token) {
		this.enabled = !(enabled===false);
		this.useCache = !(enabled===false);
		this.header = header || "X-CSRF-Token";
		this.token = token;
		if (this.useCache) {
			this.storage = new Storage("csrf");
			this.token = token || this.storage.value;
		}
	};

	scope.AjaxCSRFPlugin.prototype = {

		requestHandler:function(ajaxOpts) {
			var headers = DataUtils.getPathValue("headers", ajaxOpts);
			if (this.enabled && headers && this.token) {
				var csrf = DataUtils.param(this.header, this.token);
				headers.push(csrf);
			}
			return ajaxOpts;
		},

		responseHandler:function(response) {
			var xhr = DataUtils.getPathValue("instance.xhr",response);
			var hasHeader = xhr && xhr.getAllResponseHeaders().indexOf(this.header) !== -1;
			if (hasHeader && this.enabled) {
		  		var csrf = xhr.getResponseHeader(this.header);
		  		this.token = csrf;
		  		if (this.useCache) {
					this.storage.value = csrf;
				}
			}
			return response;
		},
		reset:function() {

		}
	};
}(window.StrandLib = window.StrandLib || {}));

</script>
