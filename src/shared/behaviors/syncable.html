<link rel="import" href="../js/sync.html"/>
<link rel="import" href="../js/datautils.html"/>
<link rel="import" href="../js/ajax.html"/>
<link rel="import" href="../behaviors/domgettable.html"/>
<link rel="import" href="../behaviors/falsifiable.html"/>
<script>
/**
 * @license
 * Copyright (c) 2015 MediaMath Inc. All rights reserved.
 * This code may only be used under the BSD style license found at http://mediamath.github.io/strand/LICENSE.txt

*/
(function(scope) {

	var DataUtils = StrandLib.DataUtils;
	var Sync = StrandLib.Sync;

	var Syncable = {
		properties: {
			_sync: {
				type:Object,
				value:function() {
					return new Sync();
				}
			},

			endpoint:{
				type:String,
				value:"/",
				observer:"_updateEndpoint"
			},

			auto:{
				type:Boolean,
				value:true,
			},
			autoDebounce:{
				type:Number,
				value:200
			},

			options:{
				type:Object,
				value:function() {
					return {
						contentType:"application/x-www-form-urlencoded",
						timeout:10000,
						withCredentials:false,
						concurrency:4
					};
				},
				observer:"_updateOptions"
			},

			data: {
				type:Object,
				value: function() {
					return {};
				},
				observe:"_dataChanged"
			},

			saveResponse: {
				type:Boolean,
				value:true
			},

			apiMarshaller:{
				type:Object,
				value:function() {
					return {
						noop:function(o) {return o;}
					};
				},
				observer:"_updateMarshaller"
			},

			responseMarshaller: {
				type:String,
				value:"noop",
				observer:"_updateMarshaller"
			},

			requestMarshaller: {
				type:String,
				value:"noop",
				observer:"_updateMarshaller"
			},

			cacheGlobals: {
				type:Boolean,
				value:false,
			},

			cacheCsrf:{
				type:Boolean,
				value:false,
				observer:"_updateCSRF"
			},
			csrfHeader:{
				type:String,
				value:"X-CSRF-Token",
				observer:"_updateCSRF"
			},
			cacheBuster: {
				type:Boolean,
				value:true,
				observer:"_updateBuster"
			},
			
		},

		get: function(data, options) {
			return this._sync.get(data, options);
		},

		post: function(data, options) {
			return this._sync.get(data, options);
		},

		put: function(data, options) {
			return this._sync.get(data, options);
		},

		delete: function (data, options) {
			return this._sync.get(data, options);
		},

		sync: function(method, data, options) {
			return this._sync.sync(method, data, options);
		},

		_updateEndpoint: function() {
			this._sync.endpoint = this.endpoint;
		},

		_updateOptions: function() {
			this._sync.options = this.options;
		},

		_updateMarshaller: function() {

			this._sync.apiConfig = DataUtils.copy(this._sync.apiConfig, {
				marshaller:this.apiMarshaller,
				defaultRequest:this.requestMarshaller,
				defaultResponse:this.responseMarshaller
			});
		},

		_updateCSRF: function() {
			this._sync.csrfConfig = DataUtils.copy(this._sync.csrfConfig, {
				enabled:this.cacheCsrf,
				useCache:this.cacheCsrf,
				header:this.csrfHeader
			});
		},

		_updateBuster: function() {
			this._sync.busterConfig = DataUtils.copy(this._sync.busterConfig, {
				enabled:this.cacheBuster,
				name: typeof this.cacheBuster === "string" ? this.cacheBuster : "nocache"
			});
		},

		_getDomConfig: function(method, domObject) {
			var domConfig = method === Ajax.GET ? this.domObject["input-params"] : this.domObject["output-params"];
			domConfig = _getParamBase(domConfig) || _getParamBase();

			return {
				headers: domConfig.headers.map(DataUtils.nodeToParam),
				params: domConfig.params.map(DataUtils.nodeToParam),
				urlParams: domConfig.urlParams.map(DataUtils.nodeInnerValue)
			};
		},

		domObjectChanged: function(domObject) {
			if (this.auto && this.auto !== "save") {
				this.debounce("dom", this.get, this.autoDebounce);
			}
		},

		_dataChanged:function(oldData, newData) {
			if (this.auto && this.auto !== "load") {
				this.debounce("dom", this.post, this.autoDebounce);
			}
		},

		_handleError: function(error) {
			this.fire("data-error",error);
		},

		setGlobal: function(key, value) {
			this._sync.setGlobal(key, value);
		},

		getGlobal: function(key) {
			return this._sync.getGlobal(key);
		}
	};
	scope.Syncable = [
		scope.DomGettable,
		scope.Falsifiable,
		Syncable,
	];
}(window.StrandTraits = window.StrandTraits || {}));

</script>
